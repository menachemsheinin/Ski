<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×§×‘ ××™××•× ×™ ×¡×§×™ - ×§×‘×•×¦×ª×™ ğŸ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: 'ğŸ¿';
            position: absolute;
            font-size: 150px;
            opacity: 0.1;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
        }

        .countdown {
            font-size: 1.2em;
            margin-top: 15px;
            background: rgba(255,255,255,0.2);
            padding: 15px 30px;
            border-radius: 10px;
            display: inline-block;
        }

        .countdown-grid {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 10px;
        }

        .countdown-item {
            text-align: center;
        }

        .countdown-number {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }

        .countdown-label {
            font-size: 0.8em;
            opacity: 0.9;
        }

        .user-selector {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 3px solid #e0e0e0;
        }

        .user-selector h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .user-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .user-card.active {
            border-color: currentColor;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            transform: scale(1.05);
        }

        .user-emoji {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .user-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .user-score {
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 10px;
        }

        .leaderboard-section {
            padding: 30px;
            background: #fff9e6;
            border-bottom: 3px solid #e0e0e0;
        }

        .leaderboard-title {
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #333;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .bars-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 250px;
            gap: 20px;
            padding: 20px 0;
        }

        .bar-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .bar {
            width: 100%;
            max-width: 80px;
            background: linear-gradient(to top, currentColor, transparent);
            border-radius: 10px 10px 0 0;
            position: relative;
            transition: height 0.5s ease;
            min-height: 20px;
        }

        .bar-label {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            font-size: 1.2em;
            color: #333;
        }

        .bar-user {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .bar-name {
            font-weight: bold;
            color: #333;
        }

        .podium {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .podium-place {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            min-width: 150px;
        }

        .podium-place.first {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            transform: translateY(-10px);
        }

        .podium-place.second {
            background: linear-gradient(135deg, #C0C0C0 0%, #A8A8A8 100%);
        }

        .podium-place.third {
            background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%);
        }

        .place-emoji {
            font-size: 3em;
        }

        .place-name {
            font-size: 1.2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .place-score {
            font-size: 1.5em;
            font-weight: bold;
        }

        .activity-feed {
            padding: 30px;
            background: #f0f8ff;
            border-bottom: 3px solid #e0e0e0;
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-feed h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .activity-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-right: 4px solid currentColor;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .activity-emoji {
            font-size: 2em;
        }

        .activity-text {
            flex: 1;
        }

        .activity-time {
            color: #999;
            font-size: 0.85em;
        }

        .weeks-container {
            padding: 30px;
        }

        .current-user-badge {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 20px;
            border-radius: 10px;
        }

        .week {
            margin-bottom: 25px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .week:hover {
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .week.completed {
            border-color: #38ef7d;
            background: #f0fdf4;
        }

        .week-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .week.completed .week-header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .week-badge {
            background: rgba(255,255,255,0.3);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .workouts {
            padding: 20px;
        }

        .workout {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .workout:hover {
            border-color: currentColor;
        }

        .workout.completed {
            background: #f0fdf4;
            border-color: currentColor;
        }

        .workout-checkbox {
            width: 30px;
            height: 30px;
            border: 3px solid currentColor;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .workout.completed .workout-checkbox {
            background: currentColor;
            color: white;
        }

        .workout-info {
            flex: 1;
        }

        .workout-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .workout-details {
            color: #666;
            font-size: 0.9em;
        }

        .workout-date {
            color: #999;
            font-size: 0.85em;
        }

        .motivation {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            60% { transform: translateY(-10px); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }

        .bouncing {
            animation: bounce 1s ease;
        }

        .pulsing {
            animation: pulse 0.5s ease-in-out 3;
        }

        .confetti {
            position: fixed;
            pointer-events: none;
            font-size: 30px;
            animation: confetti 1.5s ease-out forwards;
            z-index: 1000;
        }

        .milestone-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 40px 60px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            z-index: 2000;
            text-align: center;
            font-size: 2em;
            font-weight: bold;
            transition: transform 0.3s ease;
        }

        .milestone-popup.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .overtake-alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: linear-gradient(135deg, #FF6B6B 0%, #FFD93D 100%);
            color: white;
            padding: 20px 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2000;
            font-size: 1.3em;
            font-weight: bold;
            transition: transform 0.5s ease;
        }

        .overtake-alert.show {
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¿ ××¡×¢ ×”××™××•× ×™× ×”××©×•×ª×£ ×©×œ× ×•</h1>
            <div class="countdown">
                â° ×–××Ÿ ×¢×“ ×”×˜×™×¡×”:
                <div class="countdown-grid">
                    <div class="countdown-item">
                        <span class="countdown-number" id="daysLeft">0</span>
                        <span class="countdown-label">×™××™×</span>
                    </div>
                    <div class="countdown-item">
                        <span class="countdown-number" id="hoursLeft">0</span>
                        <span class="countdown-label">×©×¢×•×ª</span>
                    </div>
                    <div class="countdown-item">
                        <span class="countdown-number" id="minutesLeft">0</span>
                        <span class="countdown-label">×“×§×•×ª</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="user-selector">
            <h3>×‘×—×¨ ××ª ×”×©× ×©×œ×š ğŸ‘‡</h3>
            <div class="users-grid" id="usersGrid">
                <!-- Users will be generated here -->
            </div>
        </div>

        <div class="leaderboard-section">
            <h2 class="leaderboard-title">ğŸ† ×œ×•×— ×”×ª×•×¦××•×ª</h2>
            
            <div class="chart-container">
                <div class="bars-chart" id="barsChart">
                    <!-- Bars will be generated here -->
                </div>
            </div>

            <div class="podium" id="podium">
                <!-- Podium will be generated here -->
            </div>
        </div>

        <div class="activity-feed" id="activityFeed">
            <h3>ğŸ“¢ ×¤×¢×™×œ×•×ª ××—×¨×•× ×”</h3>
            <div id="activityList">
                <div style="text-align: center; color: #999; padding: 20px;">
                    ×¢×“×™×™×Ÿ ××™×Ÿ ×¤×¢×™×œ×•×ª... ×”×™×• ×”×¨××©×•× ×™×!
                </div>
            </div>
        </div>

        <div class="weeks-container" id="weeksContainer">
            <div class="current-user-badge" id="currentUserBadge">
                ×‘×—×¨ ××©×ª××© ×œ××¢×œ×” ×›×“×™ ×œ×”×ª×—×™×œ
            </div>
            <div id="workoutsContent">
                <!-- Weeks and workouts will be generated here -->
            </div>
        </div>

        <div class="motivation" id="motivationText">
            ğŸ’ª ×‘×•××• × ×ª×—×™×œ! ×‘×—×¨×• ××ª ×”×©× ×©×œ×›× ×•×ª×ª×—×™×œ×• ×œ×¡××Ÿ ××™××•× ×™×
        </div>
    </div>

    <script>
        const users = {
            'narya': { name: '× ×¨×™×”', emoji: 'ğŸ”¥', color: '#FF6B6B' },
            'israel': { name: '×™×©×¨××œ', emoji: 'ğŸ’ª', color: '#4ECDC4' },
            'gil': { name: '×’×™×œ', emoji: 'âš¡', color: '#FFD93D' },
            'menachem': { name: '×× ×—×', emoji: 'ğŸš€', color: '#A78BFA' }
        };

        const workoutTypes = {
            'A': {
                name: '×—×™×–×•×§ ×¨×’×œ×™×™×',
                details: '×¡×§×•×•××˜, ×œ×× ×’\'×¡, ×¢××™×“×” ×¢×œ ×¨×’×œ ××—×ª, ×§×¤×™×¦×•×ª'
            },
            'B': {
                name: '×œ×™×‘×” ×•×™×¦×™×‘×•×ª',
                details: '×¤×œ×× ×§, ×¤×œ×× ×§ ×¦×™×“×™, ×‘×¨×™×“×’\', ×¨×•×¡×™××Ÿ ×˜×•×•×™×¡×˜'
            },
            'C': {
                name: '×©×™×œ×•×‘ ×•××™×¨×•×‘×™',
                details: '20 ×“×§\' ××™×¨×•×‘×™ + ×¡×§×•×•××˜ + ×¤×œ×× ×§ + ××ª×™×—×•×ª'
            }
        };

        const weeks = [
            { start: '25.12', end: '31.12', workouts: ['A', 'B'] },
            { start: '1.1', end: '7.1', workouts: ['A', 'B'] },
            { start: '8.1', end: '14.1', workouts: ['A', 'B'] },
            { start: '15.1', end: '21.1', workouts: ['A', 'B'] },
            { start: '22.1', end: '28.1', workouts: ['A', 'B'] },
            { start: '29.1', end: '4.2', workouts: ['A', 'B'] },
            { start: '5.2', end: '11.2', workouts: ['A', 'B'] },
            { start: '12.2', end: '18.2', workouts: ['A', 'B'] }
        ];

        const motivationalMessages = [
            'ğŸ”¥ ××©! ××ª×” ×¢×œ ×–×”!',
            'ğŸ’ª ×›×•×— ×¢×¦×•×! ×ª××©×™×š ×›×›×”!',
            'â­ ××“×”×™×! ×”×¨×™ ×”×©×œ×’ ××—×›×™× ×œ×š!',
            'ğŸš€ ×‘×•×! ×¢×•×“ ×¦×¢×“ ×œ×§×¨××ª ×”×¤×¡×’×”!',
            'ğŸ¿ ×™××œ×œ×”! ××ª×” ××ª×§×¨×‘ ×œ×™×¢×“!',
            'â„ï¸ ×§×¨ ×©× ×œ××¢×œ×”, ××‘×œ ××ª×” ×—×!',
            'ğŸ”ï¸ ×›××¢×˜ ×©×! ×ª××©×™×š ×œ×“×—×•×£!'
        ];

        let currentUser = localStorage.getItem('currentUser') || null;
        let userData = {};
        let activityLog = [];

        // Check if storage API is available
        const hasStorageAPI = typeof window.storage !== 'undefined';

        async function loadData() {
            if (hasStorageAPI) {
                try {
                    // Load all user data
                    for (let userId in users) {
                        const result = await window.storage.get(`workouts_${userId}`, true);
                        userData[userId] = result ? JSON.parse(result.value) : [];
                    }
                    
                    // Load activity log
                    const activityResult = await window.storage.get('activity_log', true);
                    activityLog = activityResult ? JSON.parse(activityResult.value) : [];
                } catch (e) {
                    console.log('Storage API not available, using localStorage');
                    loadFromLocalStorage();
                }
            } else {
                loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            for (let userId in users) {
                const stored = localStorage.getItem(`workouts_${userId}`);
                userData[userId] = stored ? JSON.parse(stored) : [];
            }
            const storedActivity = localStorage.getItem('activity_log');
            activityLog = storedActivity ? JSON.parse(storedActivity) : [];
        }

        async function saveData(userId) {
            if (hasStorageAPI) {
                try {
                    await window.storage.set(`workouts_${userId}`, JSON.stringify(userData[userId]), true);
                    await window.storage.set('activity_log', JSON.stringify(activityLog), true);
                } catch (e) {
                    localStorage.setItem(`workouts_${userId}`, JSON.stringify(userData[userId]));
                    localStorage.setItem('activity_log', JSON.stringify(activityLog));
                }
            } else {
                localStorage.setItem(`workouts_${userId}`, JSON.stringify(userData[userId]));
                localStorage.setItem('activity_log', JSON.stringify(activityLog));
            }
        }

        function initializeApp() {
            renderUserSelector();
            renderLeaderboard();
            renderActivityFeed();
            
            if (currentUser) {
                selectUser(currentUser);
            }
            
            updateCountdown();
        }

        function renderUserSelector() {
            const grid = document.getElementById('usersGrid');
            grid.innerHTML = '';
            
            Object.keys(users).forEach(userId => {
                const user = users[userId];
                const score = userData[userId] ? userData[userId].length : 0;
                
                const card = document.createElement('div');
                card.className = 'user-card';
                if (userId === currentUser) {
                    card.classList.add('active');
                }
                card.style.color = user.color;
                
                card.innerHTML = `
                    <div class="user-emoji">${user.emoji}</div>
                    <div class="user-name">${user.name}</div>
                    <div class="user-score">${score}/16 ××™××•× ×™×</div>
                `;
                
                card.onclick = () => selectUser(userId);
                grid.appendChild(card);
            });
        }

        function selectUser(userId) {
            const previousUser = currentUser;
            currentUser = userId;
            localStorage.setItem('currentUser', userId);
            
            const user = users[userId];
            document.getElementById('currentUserBadge').innerHTML = `
                ${user.emoji} ××ª×” ××—×•×‘×¨ ×‘×ª×•×¨: <strong>${user.name}</strong>
            `;
            document.getElementById('currentUserBadge').style.background = `linear-gradient(135deg, ${user.color}, ${adjustColor(user.color, -20)})`;
            
            renderUserSelector();
            renderWorkouts();
            
            if (previousUser !== userId) {
                document.getElementById('motivationText').textContent = `${user.emoji} ×©×œ×•× ${user.name}! ×‘×•××• × ×¨××” ××™×š ××ª×” ××ª×§×“×!`;
            }
        }

        function adjustColor(color, amount) {
            return '#' + color.replace(/^#/, '').replace(/../g, color => ('0' + Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2));
        }

        function renderWorkouts() {
            const container = document.getElementById('workoutsContent');
            container.innerHTML = '';
            
            if (!currentUser) {
                return;
            }
            
            const userWorkouts = userData[currentUser] || [];
            const user = users[currentUser];
            
            weeks.forEach((week, weekIndex) => {
                const weekDiv = document.createElement('div');
                weekDiv.className = 'week';
                weekDiv.id = `week-${weekIndex}`;
                
                const weekHeader = document.createElement('div');
                weekHeader.className = 'week-header';
                weekHeader.innerHTML = `
                    <span>×©×‘×•×¢ ${weekIndex + 1} (${week.start} - ${week.end})</span>
                    <span class="week-badge" id="badge-${weekIndex}">0/2</span>
                `;
                
                const workoutsDiv = document.createElement('div');
                workoutsDiv.className = 'workouts';
                
                week.workouts.forEach((type, workoutIndex) => {
                    const workoutId = `${weekIndex}-${workoutIndex}`;
                    const workout = workoutTypes[type];
                    const isCompleted = userWorkouts.includes(workoutId);
                    
                    const workoutDiv = document.createElement('div');
                    workoutDiv.className = 'workout';
                    workoutDiv.style.color = user.color;
                    if (isCompleted) {
                        workoutDiv.classList.add('completed');
                    }
                    
                    workoutDiv.innerHTML = `
                        <div class="workout-checkbox">${isCompleted ? 'âœ“' : ''}</div>
                        <div class="workout-info">
                            <div class="workout-name">××™××•×Ÿ ${type} - ${workout.name}</div>
                            <div class="workout-details">${workout.details}</div>
                            <div class="workout-date" id="date-${currentUser}-${workoutId}"></div>
                        </div>
                    `;
                    
                    workoutDiv.onclick = () => toggleWorkout(workoutId);
                    workoutsDiv.appendChild(workoutDiv);
                });
                
                weekDiv.appendChild(weekHeader);
                weekDiv.appendChild(workoutsDiv);
                container.appendChild(weekDiv);
                
                updateWeekStatus(weekIndex);
            });
        }

        async function toggleWorkout(workoutId) {
            if (!currentUser) return;
            
            const userWorkouts = userData[currentUser] || [];
            const user = users[currentUser];
            const workoutDiv = event.currentTarget;
            const previousScore = userWorkouts.length;
            
            if (userWorkouts.includes(workoutId)) {
                // Remove workout
                userData[currentUser] = userWorkouts.filter(id => id !== workoutId);
                workoutDiv.classList.remove('completed');
                workoutDiv.querySelector('.workout-checkbox').textContent = '';
            } else {
                // Add workout
                userData[currentUser] = [...userWorkouts, workoutId];
                workoutDiv.classList.add('completed');
                workoutDiv.querySelector('.workout-checkbox').textContent = 'âœ“';
                workoutDiv.classList.add('pulsing');
                
                // Create confetti
                createConfetti(event.clientX, event.clientY, user.color);
                
                // Add to activity log
                const now = new Date();
                addActivity(currentUser, workoutId, now);
                
                setTimeout(() => workoutDiv.classList.remove('pulsing'), 1500);
                
                // Show motivational message
                const randomMessage = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];
                const motivationEl = document.getElementById('motivationText');
                motivationEl.textContent = `${user.emoji} ${randomMessage}`;
                motivationEl.classList.add('bouncing');
                setTimeout(() => motivationEl.classList.remove('bouncing'), 1000);
                
                // Check for milestones and overtakes
                checkMilestones(userData[currentUser].length);
                checkOvertakes(previousScore, userData[currentUser].length);
            }
            
            await saveData(currentUser);
            renderUserSelector();
            renderLeaderboard();
            renderActivityFeed();
            
            const weekIndex = parseInt(workoutId.split('-')[0]);
            updateWeekStatus(weekIndex);
        }

        function updateWeekStatus(weekIndex) {
            if (!currentUser) return;
            
            const userWorkouts = userData[currentUser] || [];
            const weekWorkouts = weeks[weekIndex].workouts.length;
            let completed = 0;
            
            for (let i = 0; i < weekWorkouts; i++) {
                if (userWorkouts.includes(`${weekIndex}-${i}`)) {
                    completed++;
                }
            }
            
            const badge = document.getElementById(`badge-${weekIndex}`);
            if (badge) {
                badge.textContent = `${completed}/${weekWorkouts}`;
            }
            
            const weekDiv = document.getElementById(`week-${weekIndex}`);
            if (weekDiv) {
                if (completed === weekWorkouts) {
                    weekDiv.classList.add('completed');
                } else {
                    weekDiv.classList.remove('completed');
                }
            }
        }

        function renderLeaderboard() {
            const barsChart = document.getElementById('barsChart');
            barsChart.innerHTML = '';
            
            const sorted = Object.keys(users).sort((a, b) => {
                return (userData[b]?.length || 0) - (userData[a]?.length || 0);
            });
            
            const maxScore = Math.max(...Object.values(userData).map(w => w?.length || 0), 1);
            
            sorted.forEach(userId => {
                const user = users[userId];
                const score = userData[userId]?.length || 0;
                const heightPercent = (score / 16) * 100;
                
                const barContainer = document.createElement('div');
                barContainer.className = 'bar-container';
                
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = heightPercent + '%';
                bar.style.color = user.color;
                
                const label = document.createElement('div');
                label.className = 'bar-label';
                label.textContent = score;
                bar.appendChild(label);
                
                const barUser = document.createElement('div');
                barUser.className = 'bar-user';
                barUser.textContent = user.emoji;
                
                const barName = document.createElement('div');
                barName.className = 'bar-name';
                barName.textContent = user.name;
                barName.style.color = user.color;
                
                barContainer.appendChild(bar);
                barContainer.appendChild(barUser);
                barContainer.appendChild(barName);
                barsChart.appendChild(barContainer);
            });
            
            // Render podium
            renderPodium(sorted);
        }

        function renderPodium(sorted) {
            const podium = document.getElementById('podium');
            podium.innerHTML = '';
            
            const places = ['second', 'first', 'third'];
            const medals = ['ğŸ¥ˆ', 'ğŸ¥‡', 'ğŸ¥‰'];
            const podiumOrder = [sorted[1], sorted[0], sorted[2]];
            
            podiumOrder.forEach((userId, index) => {
                if (!userId) return;
                
                const user = users[userId];
                const score = userData[userId]?.length || 0;
                
                const place = document.createElement('div');
                place.className = `podium-place ${places[index]}`;
                
                place.innerHTML = `
                    <div class="place-emoji">${medals[index]}</div>
                    <div>${user.emoji}</div>
                    <div class="place-name">${user.name}</div>
                    <div class="place-score">${score}/16</div>
                `;
                
                podium.appendChild(place);
            });
        }

        function addActivity(userId, workoutId, timestamp) {
            const user = users[userId];
            const [weekIndex, workoutIndex] = workoutId.split('-');
            const workoutType = weeks[weekIndex].workouts[workoutIndex];
            const workout = workoutTypes[workoutType];
            
            const activity = {
                userId,
                workoutName: `××™××•×Ÿ ${workoutType} - ${workout.name}`,
                timestamp: timestamp.getTime()
            };
            
            activityLog.unshift(activity);
            activityLog = activityLog.slice(0, 20); // Keep only last 20
        }

        function renderActivityFeed() {
            const list = document.getElementById('activityList');
            
            if (activityLog.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">×¢×“×™×™×Ÿ ××™×Ÿ ×¤×¢×™×œ×•×ª... ×”×™×• ×”×¨××©×•× ×™×!</div>';
                return;
            }
            
            list.innerHTML = '';
            
            activityLog.forEach(activity => {
                const user = users[activity.userId];
                const timeAgo = getTimeAgo(activity.timestamp);
                
                const item = document.createElement('div');
                item.className = 'activity-item';
                item.style.color = user.color;
                
                item.innerHTML = `
                    <div class="activity-emoji">${user.emoji}</div>
                    <div class="activity-text">
                        <strong>${user.name}</strong> ×”×©×œ×™× ${activity.workoutName}
                        <div class="activity-time">${timeAgo}</div>
                    </div>
                `;
                
                list.appendChild(item);
            });
        }

        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return '×¢×›×©×™×•';
            if (minutes < 60) return `×œ×¤× ×™ ${minutes} ×“×§×•×ª`;
            if (hours < 24) return `×œ×¤× ×™ ${hours} ×©×¢×•×ª`;
            return `×œ×¤× ×™ ${days} ×™××™×`;
        }

        function createConfetti(x, y, color) {
            const emojis = ['ğŸ‰', 'â­', 'ğŸ’ª', 'ğŸ”¥', 'âœ¨', 'ğŸŠ', 'ğŸ†', 'â„ï¸'];
            const count = 12;
            
            for (let i = 0; i < count; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                confetti.style.left = x + (Math.random() - 0.5) * 100 + 'px';
                confetti.style.top = y + 'px';
                confetti.style.color = color;
                confetti.style.animationDelay = (Math.random() * 0.3) + 's';
                
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 1500);
            }
        }

        function checkMilestones(score) {
            if (score === 2) {
                showMilestonePopup('ğŸ¯ ×©×‘×•×¢ ×¨××©×•×Ÿ ×”×•×©×œ×!');
            } else if (score === 8) {
                showMilestonePopup('ğŸ”¥ 4 ×©×‘×•×¢×•×ª! ××ª×” ×‘×œ×ª×™ ×¢×¦×•×¨!');
            } else if (score === 12) {
                showMilestonePopup('â­ 75% ×”×•×©×œ××•! ×›××¢×˜ ×©×!');
            } else if (score === 16) {
                showMilestonePopup('ğŸ’ª ××œ×•×£! ×”×©×œ××ª ××ª ×›×œ ×”××™××•× ×™×!');
            }
        }

        function checkOvertakes(previousScore, newScore) {
            if (!currentUser) return;
            
            const currentUserData = users[currentUser];
            const sorted = Object.keys(users).sort((a, b) => {
                return (userData[b]?.length || 0) - (userData[a]?.length || 0);
            });
            
            // Check if we just overtook someone
            Object.keys(users).forEach(userId => {
                if (userId === currentUser) return;
                
                const theirScore = userData[userId]?.length || 0;
                if (previousScore <= theirScore && newScore > theirScore) {
                    showOvertakeAlert(users[userId].name);
                }
            });
        }

        function showMilestonePopup(message) {
            const popup = document.createElement('div');
            popup.className = 'milestone-popup';
            popup.textContent = message;
            document.body.appendChild(popup);
            
            setTimeout(() => popup.classList.add('show'), 10);
            
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    createConfetti(window.innerWidth / 2, window.innerHeight / 2, users[currentUser].color);
                }, i * 200);
            }
            
            setTimeout(() => {
                popup.classList.remove('show');
                setTimeout(() => popup.remove(), 300);
            }, 3000);
        }

        function showOvertakeAlert(overtakenName) {
            const alert = document.createElement('div');
            alert.className = 'overtake-alert';
            alert.textContent = `ğŸ‰ ×¢×§×¤×ª ××ª ${overtakenName}! ××¢×•×œ×”!`;
            document.body.appendChild(alert);
            
            setTimeout(() => alert.classList.add('show'), 10);
            
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 500);
            }, 3000);
        }

        function updateCountdown() {
            const now = new Date();
            const skiDate = new Date('2026-02-22T23:00:00');
            
            const diff = skiDate - now;
            
            if (diff <= 0) {
                document.getElementById('daysLeft').textContent = '0';
                document.getElementById('hoursLeft').textContent = '0';
                document.getElementById('minutesLeft').textContent = '0';
                return;
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            document.getElementById('daysLeft').textContent = days;
            document.getElementById('hoursLeft').textContent = hours;
            document.getElementById('minutesLeft').textContent = minutes;
        }

        // Update countdown every minute
        setInterval(updateCountdown, 60000);

        // Initialize
        loadData().then(() => {
            initializeApp();
        });
    </script>
</body>
</html>